<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>The Diet Planner - Local Dev</title>
  <style>
    body{font-family:Inter,Arial,Helvetica,sans-serif;margin:0;background:#f8fafc;color:#222}
    .container{max-width:1100px;margin:24px auto;padding:18px;background:#fff;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:18px}
    .card{background:#fff;padding:12px;border-radius:8px;border:1px solid #eef2f6}
    label{display:block;margin:8px 0 6px;font-weight:600}
    input,select{width:100%;padding:10px;border-radius:6px;border:1px solid #d7e1ea}
    button{background:#007bff;color:#fff;padding:10px 14px;border-radius:8px;border:0;cursor:pointer}
    .stats{display:flex;gap:8px;flex-wrap:wrap}
    .stat-card{flex:1 1 150px;padding:12px;border-radius:8px;border:1px solid #eef2f6;background:#fff}
    table.table{width:100%;border-collapse:collapse}
    table.table th, table.table td{padding:8px;border:1px solid #e9eef2}
    .day-header{font-weight:700;color:#0b5cff}
    .meal-serving{font-size:12px;color:#6c757d}
    .text-success{color:#28a745}
    #calorieChart, #macrosChart{height:160px;display:block}
    pre.console-dump{max-height:200px;overflow:auto;background:#0f1724;color:#d1fae5;padding:8px;border-radius:6px}
  </style>
</head>
<body data-diet-tracker-url="https://thedietplanner.com/diet-tracker">
  <div class="container">
    <h1>The Diet Planner — Demo</h1>
    <div class="grid">
      <div>
        <div class="card">
          <h3>Profile</h3>
          <label for="age">Age</label><input id="age" type="number" value="30" />
          <label for="gender">Gender</label>
          <select id="gender"><option value="male">Male</option><option value="female">Female</option></select>
          <label for="height">Height (cm)</label><input id="height" type="number" value="175" />
          <label for="weight">Weight (kg)</label><input id="weight" type="number" value="75" />
          <label for="goal">Goal</label>
          <select id="goal"><option value="maintain">Maintain</option><option value="loss">Weight Loss</option><option value="gain">Gain</option></select>
          <label for="dietType">Dietary Preference</label>
          <select id="dietType"><option value="Regular">Regular</option><option value="Vegetarian">Vegetarian</option><option value="Vegan">Vegan</option></select>
          <label for="region">Region</label>
          <select id="region"><option value="USA">USA</option><option value="India">India</option><option value="Latin_American">Latin America</option><option value="African">African</option></select>
          <label for="activityLevel">Activity Level</label>
          <select id="activityLevel"><option value="low">Low</option><option value="moderate">Moderate</option><option value="high">High</option><option value="very-high">Very High</option></select>
          <label for="targetCalories">Target Daily Calories (optional)</label><input id="targetCalories" type="number" />
          <div style="margin-top:12px;display:flex;gap:8px">
            <button id="generateBtn">Generate My Meal Plan</button>
            <button id="downloadPdfBtn" type="button">Download PDF</button>
            <button id="downloadCsvBtn" type="button">Download CSV</button>
            <button id="sendToTrackerBtn" type="button">Send to Tracker</button>
          </div>
          <div style="margin-top:8px;font-size:12px;color:#6c757d">Put <code>meals.json</code> at project root or <code>data/meals.json</code> or same dir.</div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3>Charts</h3>
          <canvas id="calorieChart"></canvas>
          <canvas id="macrosChart" style="margin-top:12px"></canvas>
        </div>
      </div>

      <div>
        <div class="card stats" id="statsGrid">
          <div class="stat-card"><div class="stat-title">Calories</div><div class="stat-value">—</div></div>
          <div class="stat-card"><div class="stat-title">Protein</div><div class="stat-value">—</div></div>
          <div class="stat-card"><div class="stat-title">Carbs</div><div class="stat-value">—</div></div>
          <div class="stat-card"><div class="stat-title">Fat</div><div class="stat-value">—</div></div>
          <div class="stat-card"><div class="stat-title">Fiber</div><div class="stat-value">—</div></div>
        </div>

        <div style="height:12px"></div>

        <div class="card" id="mealPlanTable" style="min-height:300px;overflow:auto">
          <h3>Your Meal Plan</h3>
          <div class="text-muted">Generate a plan to view table here.</div>
        </div>
      </div>
    </div>

    <div style="margin-top:14px">
      <h4>Console diagnostics</h4>
      <pre class="console-dump" id="diagConsole">Open browser devtools for full logs.</pre>
    </div>
  </div>

  <script>
  /*
    Consolidated script
    - robust meals.json loader and normalizer
    - meal selection
    - PDF & CSV export
    - charts (lazy)
    - safe initialization stubs so file can replace your previous HTML
  */

  // --- global state
  let mealDatabase = null;
  let mealDbLoadPromise = null;
  let currentMealPlan = null;
  let currentUserProfile = null;
  let ChartsLoaded = false;
  let Html2PdfLoaded = false;
  let calorieChartInstance = null;
  let macrosChartInstance = null;

  const INTEGRATION_STORAGE_KEY = 'dietplanner_integration_v3';

  const DIAG = (s) => {
    try {
      const el = document.getElementById('diagConsole');
      if (el) {
        el.textContent = (new Date()).toLocaleTimeString() + ' — ' + String(s) + '\n' + el.textContent;
      } else console.log(s);
    } catch(e){ console.log(s); }
  };

  function safeNumber(v) {
    if (v === null || v === undefined || v === '') return 0;
    if (typeof v === 'number') return Number.isFinite(v) ? v : 0;
    const n = parseFloat(String(v).replace(/[^\d.-]/g,''));
    return Number.isFinite(n) ? n : 0;
  }

  // ---------------------------
  // Robust meals.json loader + normalizer
  // ---------------------------
  async function loadMealsDatabase(force = false) {
      if (mealDatabase && !force) return mealDatabase;
      if (mealDbLoadPromise && !force) return mealDbLoadPromise;

      mealDbLoadPromise = (async () => {
          const candidates = ['meals.json', '/meals.json', 'data/meals.json', location.origin + '/meals.json'];
          let raw = null;
          for (const url of candidates) {
              try {
                  const res = await fetch(url, { cache: 'no-store' });
                  if (!res.ok) throw new Error('HTTP ' + res.status);
                  raw = await res.json();
                  console.log('✅ Loaded meals.json from', url);
                  DIAG('Loaded meals.json from ' + url);
                  break;
              } catch (err) {
                  console.warn('Could not load meals from', url, err && err.message ? err.message : err);
              }
          }

          if (!raw) {
              console.warn('⚠️ meals.json not found — using built-in fallback.');
              DIAG('meals.json not found — using fallback data');
              mealDatabase = createFallbackMeals();
              return mealDatabase;
          }

          // If raw is an object with a "meals" array or "data.meals", use it:
          if (raw.meals && Array.isArray(raw.meals)) raw = raw.meals;
          else if (raw.data && raw.data.meals && Array.isArray(raw.data.meals)) raw = raw.data.meals;

          // If raw is a flat array of meal objects -> convert to normalized shape
          if (Array.isArray(raw)) {
              const normalized = {};
              for (let i = 0; i < raw.length; i++) {
                  const m = raw[i];
                  if (!m || typeof m !== 'object') continue;
                  const regionKey = (m.region || 'Global').toString();
                  const diets = Array.isArray(m.diets) && m.diets.length ? m.diets : [m.diet || 'Regular'];
                  const mealType = (m.mealType || m.type || m.category || 'lunch').toString().toLowerCase();

                  if (!normalized[regionKey]) normalized[regionKey] = {};
                  for (const diet of diets) {
                      const dietKey = diet || 'Regular';
                      if (!normalized[regionKey][dietKey]) normalized[regionKey][dietKey] = { breakfast: [], lunch: [], dinner: [], snacks: [] };
                      const bucket = normalized[regionKey][dietKey];

                      // map meal object into normalized meal shape (reuse normalizeMealObject if present)
                      const norm = (typeof normalizeMealObject === 'function')
                          ? normalizeMealObject(m, i, regionKey, dietKey, mealType)
                          : {
                              id: m.id ?? `${regionKey}_${dietKey}_${mealType}_${i}`,
                              title: m.title || m.name || `Meal ${i+1}`,
                              serving_size: m.serving_size || m.serving || '',
                              calories: safeNumber(m.calories ?? m.kcal ?? 0),
                              protein: safeNumber(m.protein ?? 0),
                              carbs: safeNumber(m.carbs ?? 0),
                              fat: safeNumber(m.fat ?? 0),
                              fiber: safeNumber(m.fiber ?? 0),
                              foods: Array.isArray(m.foods) ? m.foods : (m.ingredients ? String(m.ingredients).split(',').map(s=>({name:s.trim()})) : [])
                          };

                      const key = (['breakfast','lunch','dinner','snacks'].includes(mealType) ? mealType : (mealType.endsWith('s') ? mealType : mealType + (mealType==='snack' ? 's' : '')) );
                      const targetKey = ['breakfast','lunch','dinner','snacks'].includes(key) ? key : 'lunch';
                      bucket[targetKey].push(norm);
                  }
              }

              mealDatabase = normalized;
              console.log('✅ meals.json was a flat array — converted to normalized structure.');
              DIAG('meals.json was flat array — normalized');
              return mealDatabase;
          }

          // If raw appears already as nested region -> diet -> { breakfast:lunch:... }
          try {
              const normalized = {};
              const regionKeys = Object.keys(raw);
              const types = ['breakfast','lunch','dinner','snacks'];
              regionKeys.forEach(regionKey => {
                  const regionObj = raw[regionKey];
                  if (!regionObj || typeof regionObj !== 'object') return;
                  normalized[regionKey] = {};
                  Object.keys(regionObj).forEach(dietKey => {
                      const dietObj = regionObj[dietKey];
                      if (!dietObj || typeof dietObj !== 'object') return;
                      const out = {};
                      types.forEach(t => {
                          let arr = dietObj[t] || dietObj[t.charAt(0).toUpperCase()+t.slice(1)] || dietObj[t.replace('_',' ')] || [];
                          if (!Array.isArray(arr)) arr = [];
                          out[t] = arr.map((m, i) => (typeof normalizeMealObject === 'function') ? normalizeMealObject(m, i, regionKey, dietKey, t) : m);
                      });
                      normalized[regionKey][dietKey] = out;
                  });
              });
              // if normalized has any keys use it, otherwise fallback
              mealDatabase = Object.keys(normalized).length ? normalized : createFallbackMeals();
              console.log('✅ meals.json normalized and loaded.');
              DIAG('meals.json normalized — regions: ' + Object.keys(mealDatabase).join(', '));
              // print short diagnostics
              Object.keys(mealDatabase).forEach(region => {
                const diets = Object.keys(mealDatabase[region]||{});
                diets.forEach(d => {
                  const obj = mealDatabase[region][d] || {};
                  DIAG(`[DietPlanner] ${region}/${d} counts: b:${(obj.breakfast||[]).length} l:${(obj.lunch||[]).length} d:${(obj.dinner||[]).length} s:${(obj.snacks||[]).length}`);
                });
              });
              return mealDatabase;
          } catch (err) {
              console.warn('⚠️ Unexpected meals.json structure — using fallback.', err);
              mealDatabase = createFallbackMeals();
              return mealDatabase;
          }
      })();

      return mealDbLoadPromise;
  }


  function normalizeMealObject(meal, idx, region, diet, mealType) {
     if (!meal || typeof meal !== 'object') {
         return {
             id: `${region}_${diet}_${mealType}_${idx}_${Date.now()}`,
             title: `Option ${idx+1}`,
             serving_size: '1 serving',
             calories: 0, protein: 0, carbs: 0, fat: 0, fiber: 0,
             foods: []
         };
     }

     const rawTitle = (meal.title || meal.name || meal.label || meal.dish_name || meal.display_name || '').toString().trim();
     const serving_size = meal.serving_size || meal.servingSize || meal.serving || '';
     const calories = safeNumber(meal.calories ?? meal.kcal ?? meal.cal ?? 0);
     const protein = safeNumber(meal.protein ?? meal.prot ?? 0);
     const carbs = safeNumber(meal.carbs ?? meal.carbohydrates ?? 0);
     const fat = safeNumber(meal.fat ?? meal.fats ?? 0);
     const fiber = safeNumber(meal.fiber ?? meal.fib ?? 0);

     let foods = [];
     if (Array.isArray(meal.foods) && meal.foods.length) {
         foods = meal.foods.map(f => (typeof f === 'string') ? { name: f } : (typeof f === 'object' ? f : { name: String(f) }));
     } else if (meal.ingredients && typeof meal.ingredients === 'string') {
         foods = meal.ingredients.split(',').map(s => ({ name: s.trim() })).filter(Boolean);
     } else if (meal.components && Array.isArray(meal.components)) {
         foods = meal.components.map(c => (typeof c === 'string') ? { name: c } : (c || {}));
     }

     let title = rawTitle;
     if (!title) {
         const foodNames = foods.map(f => (typeof f === 'string' ? f : (f.name || f.title || '')).trim()).filter(Boolean);
         if (foodNames.length) title = foodNames.slice(0,3).join(', ');
     }
     if (!title) title = `Meal ${idx + 1}`;

     return {
         id: meal.id ?? `${region}_${diet}_${mealType}_${idx}_${Date.now()}`,
         title,
         serving_size,
         calories, protein, carbs, fat, fiber,
         foods
     };
  }

  function createFallbackMeals() {
      return {
          "India": {
              "Regular": {
                  breakfast: [
                      { id: 'fb1', title: "Oatmeal with Fruits", serving_size: "1 serving", calories: 250, protein: 8, carbs: 45, fat: 4, fiber: 5 },
                      { id: 'fb2', title: "Boiled Eggs", serving_size: "2 eggs", calories: 150, protein: 12, carbs: 1, fat: 10, fiber: 0 }
                  ],
                  lunch: [
                      { id: 'fl1', title: "Grilled Chicken Salad", serving_size: "1 bowl", calories: 350, protein: 30, carbs: 15, fat: 12, fiber: 6 },
                      { id: 'fl2', title: "Veggie Wrap", serving_size: "1 wrap", calories: 300, protein: 10, carbs: 40, fat: 8, fiber: 5 }
                  ],
                  dinner: [
                      { id: 'fd1', title: "Paneer Curry with Rice", serving_size: "1 plate", calories: 400, protein: 20, carbs: 50, fat: 15, fiber: 5 },
                      { id: 'fd2', title: "Fish with Quinoa", serving_size: "1 plate", calories: 450, protein: 35, carbs: 40, fat: 14, fiber: 4 }
                  ],
                  snacks: [
                      { id: 'fs1', title: "Fruit and Nuts", serving_size: "1 small bowl", calories: 150, protein: 4, carbs: 20, fat: 6, fiber: 3 }
                  ]
              }
          },
          "USA": {
              "Regular": {
                  breakfast: [{ id: 'us_b1', title: "Scrambled Eggs with Toast", serving_size: "1 serving", calories: 320, protein: 18, carbs: 28, fat: 14, fiber: 3 }],
                  lunch: [{ id: 'us_l1', title: "Turkey Sandwich", serving_size: "1", calories: 420, protein: 30, carbs: 45, fat: 12, fiber: 4 }],
                  dinner: [{ id: 'us_d1', title: "Grilled Salmon", serving_size: "1", calories: 500, protein: 35, carbs: 30, fat: 22, fiber: 3 }],
                  snacks: [{ id: 'us_s1', title: "Greek Yogurt & Berries", serving_size: "1 cup", calories: 160, protein: 12, carbs: 18, fat: 4, fiber: 2 }]
              }
          }
      };
  }

  // ---------------------------
  // Selection and generation logic
  // ---------------------------
  function calculateTargetCalories(profile) {
      const age = safeNumber(profile.age);
      const weight = safeNumber(profile.weight);
      const height = safeNumber(profile.height);
      const gender = (profile.gender || '').toString().toLowerCase();

      let bmr;
      if (gender === 'male' || gender === 'm') bmr = 10*weight + 6.25*height - 5*age + 5;
      else bmr = 10*weight + 6.25*height - 5*age - 161;

      const activityFactors = { 'low':1.2, 'moderate':1.375, 'high':1.55, 'very-high':1.725 };
      const activity = (profile.activityLevel || 'low').toString();
      let tdee = bmr * (activityFactors[activity] || 1.2);

      switch((profile.goal||'').toString().toLowerCase()) {
          case 'loss': case 'lose': tdee *= 0.8; break;
          case 'gain': case 'muscle': tdee *= 1.15; break;
          default: break;
      }
      tdee = Math.round(Math.max(800, Math.min(4200, tdee)));
      return tdee;
  }

  function getMealsArrayForType(dietMeals, mealType) {
      if (!dietMeals) return [];
      const variants = [
          mealType,
          mealType.toLowerCase(),
          mealType.charAt(0).toUpperCase()+mealType.slice(1),
          mealType + 's',
          mealType.replace('_',' '),
          mealType.replace('_',' ').toLowerCase()
      ];
      for (const k of variants) {
          if (k && Array.isArray(dietMeals[k]) && dietMeals[k].length) return dietMeals[k];
      }
      if (Array.isArray(dietMeals) && dietMeals.length) return dietMeals.slice();
      for (const k of Object.keys(dietMeals)) {
          if (Array.isArray(dietMeals[k]) && dietMeals[k].length) return dietMeals[k];
      }
      return [];
  }

  function selectMealsForWeek(meals, targetCalories, profile) {
      const days = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
      const mealTypes = ['breakfast','lunch','dinner','snacks'];
      const weeklyPlan = {};
      const usedMealIds = new Set();
      const calorieDistribution = { breakfast:0.25, lunch:0.35, dinner:0.35, snacks:0.05 };

      function flattenAllMeals(obj) {
          const out = [];
          if (!obj) return out;
          if (Array.isArray(obj)) return obj.slice();
          for (const k of Object.keys(obj)) {
              if (Array.isArray(obj[k])) out.push(...obj[k]);
          }
          return out;
      }
      const allAvailable = flattenAllMeals(meals);

      days.forEach((day, di) => {
          weeklyPlan[day] = {};
          mealTypes.forEach((mt, mti) => {
              const targetForMeal = Math.round((targetCalories || 2000) * (calorieDistribution[mt] || 0.25));
              let available = getMealsArrayForType(meals, mt);
              if (!available || available.length === 0) available = allAvailable.slice();

              if (!available || available.length === 0) {
                  weeklyPlan[day][mt] = createDefaultMeal(mt, targetForMeal);
                  console.warn(`[DietPlanner] No meals found for "${mt}" — using fallback.`);
                  return;
              }

              const candidates = available.filter(Boolean);
              let suitable = candidates.filter(m => {
                  const c = safeNumber(m.calories);
                  const id = m.id ?? m.title ?? String(Math.random());
                  const unused = !usedMealIds.has(id);
                  const inRange = (c === 0) || (c >= targetForMeal * 0.6 && c <= targetForMeal * 1.4);
                  return unused && inRange;
              });
              if (suitable.length === 0) suitable = candidates.filter(m => { const c = safeNumber(m.calories); return c===0 || (c >= targetForMeal * 0.6 && c <= targetForMeal * 1.4); });
              if (suitable.length === 0) suitable = candidates.filter(m => { const id = m.id ?? m.title; return !usedMealIds.has(id); });
              if (suitable.length === 0) suitable = candidates.slice();

              const seed = (di * 7 + mti) % suitable.length;
              const chosenRaw = suitable[seed] || suitable[0];

              const chosen = (function normalize(m){
                  if (!m) return createDefaultMeal(mt, targetForMeal);
                  if (typeof m !== 'object') return { id:String(m), title:String(m), serving_size:'', calories:0, protein:0, carbs:0, fat:0, fiber:0 };
                  return {
                      id: m.id ?? (m.title ? String(m.title) : `meal_${Math.random()}`),
                      title: (m.title || m.name || m.label || '').toString() || 'Meal',
                      serving_size: m.serving_size || m.serving || m.servingSize || '',
                      calories: safeNumber(m.calories ?? m.kcal ?? 0),
                      protein: safeNumber(m.protein ?? m.prot ?? 0),
                      carbs: safeNumber(m.carbs ?? m.carbohydrates ?? 0),
                      fat: safeNumber(m.fat ?? m.fats ?? 0),
                      fiber: safeNumber(m.fiber ?? 0),
                      foods: Array.isArray(m.foods) ? m.foods : (m.ingredients ? String(m.ingredients).split(',').map(s=>({name:s.trim()})) : [])
                  };
              })(chosenRaw);

              weeklyPlan[day][mt] = chosen;
              usedMealIds.add(chosen.id);
          });
      });

      return weeklyPlan;
  }

  function createDefaultMeal(mealType, targetCalories) {
      const defaults = {
          breakfast: { title:"Mixed Breakfast", serving_size:"1 serving", calories: Math.round(targetCalories) },
          lunch: { title:"Balanced Lunch", serving_size:"1 serving", calories: Math.round(targetCalories) },
          dinner: { title:"Nutritious Dinner", serving_size:"1 serving", calories: Math.round(targetCalories) },
          snacks: { title:"Healthy Snack", serving_size:"1 serving", calories: Math.round(targetCalories) }
      };
      const base = defaults[mealType] || defaults.lunch;
      return { id: `fallback_${mealType}_${Date.now()}`, ...base, protein: Math.round(targetCalories*0.15/4), carbs: Math.round(targetCalories*0.5/4), fat: Math.round(targetCalories*0.35/9), fiber:5, _isFallback:true };
  }

  // ---------------------------
  // Display & stats
  // ---------------------------
  function getMealTitle(meal) {
      if (!meal) return 'No meal';
      if (typeof meal === 'string') return meal;
      const candidates = [meal.title, meal.name, meal.display_name, meal.dish_name, meal.label];
      for (const c of candidates) if (c && String(c).trim()) return String(c).trim();
      if (Array.isArray(meal.foods) && meal.foods.length) {
          const parts = meal.foods.map(f => typeof f === 'string' ? f : (f.name || f.title || '')).filter(Boolean);
          if (parts.length) return parts.slice(0,3).join(', ');
      }
      if (meal.id) return `Meal #${meal.id}`;
      return 'Custom Meal';
  }

  function displayMealTable(weeklyPlan) {
      const container = document.getElementById('mealPlanTable');
      if (!container) return;
      const days = Object.keys(weeklyPlan || {});
      const mealTypes = [{key:'breakfast',name:'🌅 Breakfast'}, {key:'lunch',name:'🍽️ Lunch'}, {key:'dinner',name:'🌙 Dinner'}, {key:'snacks',name:'🍎 Snack'}];

      function esc(s){ if (s===null||s===undefined) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
      function num(v){ return safeNumber(v); }

      let html = '<h3>Your Meal Plan</h3>';
      html += '<table class="table"><thead><tr><th>Day</th>';
      mealTypes.forEach(mt => html += `<th>${esc(mt.name)}</th>`);
      html += '<th>Daily Total</th></tr></thead><tbody>';

      days.forEach(day => {
          html += '<tr>';
          html += `<td class="day-header">${esc(day)}</td>`;
          let totalCalories = 0;
          mealTypes.forEach(mt => {
              const meal = (weeklyPlan[day] || {})[mt.key];
              if (meal) {
                  const titleText = getMealTitle(meal);
                  const calories = num(meal.calories || meal.kcal || 0);
                  totalCalories += calories;
                  const serving = meal.serving_size || meal.servingSize || '';
                  const protein = num(meal.protein || meal.prot || 0);
                  const carbs = num(meal.carbs || meal.carbohydrates || 0);
                  const fat = num(meal.fat || meal.fats || 0);
                  const fiber = num(meal.fiber || 0);

                  html += `<td>
                      <div class="meal-item"><strong>${esc(titleText)}</strong></div>
                      <div class="meal-serving text-primary">${esc(String(calories))} kcal</div>`;
                  if (serving) html += `<div class="meal-serving">${esc(serving)}</div>`;
                  if (protein || carbs || fat || fiber) html += `<div class="meal-nutrients">P: ${esc(String(protein))}g • C: ${esc(String(carbs))}g • F: ${esc(String(fat))}g • Fib: ${esc(String(fiber))}g</div>`;
                  html += `</td>`;
              } else {
                  html += '<td><div class="text-muted">No meal</div></td>';
              }
          });
          html += `<td><strong class="text-success">${Math.round(totalCalories)} kcal</strong></td>`;
          html += '</tr>';
      });

      html += '</tbody></table>';
      container.innerHTML = html;
  }

  function calculateWeeklyStats(weeklyPlan) {
      let totalCalories=0, totalProtein=0, totalCarbs=0, totalFat=0, totalFiber=0, mealCount=0;
      Object.keys(weeklyPlan || {}).forEach(day => {
          Object.keys(weeklyPlan[day] || {}).forEach(mt => {
              const meal = weeklyPlan[day][mt];
              if (meal) {
                  totalCalories += safeNumber(meal.calories);
                  totalProtein += safeNumber(meal.protein);
                  totalCarbs += safeNumber(meal.carbs);
                  totalFat += safeNumber(meal.fat);
                  totalFiber += safeNumber(meal.fiber);
                  mealCount++;
              }
          });
      });
      return {
          totalCalories,
          avgCalories: totalCalories / 7,
          totalProtein,
          avgProtein: totalProtein / 7,
          totalCarbs,
          avgCarbs: totalCarbs / 7,
          totalFat,
          avgFat: totalFat / 7,
          totalFiber,
          avgFiber: totalFiber / 7,
          mealCount
      };
  }

  function displayStatsCards(weeklyPlan, profile) {
      const weeklyStats = calculateWeeklyStats(weeklyPlan);
      const container = document.getElementById('statsGrid');
      if (!container) return;
      container.innerHTML = `
          <div class="stat-card"><div class="stat-title">Calories</div><div class="stat-value">${Math.round(weeklyStats.avgCalories||0)}</div><div class="stat-target">/ ${profile.targetCalories||'—'}</div></div>
          <div class="stat-card"><div class="stat-title">Protein</div><div class="stat-value">${Math.round(weeklyStats.avgProtein||0)}<span class="stat-unit">g</span></div></div>
          <div class="stat-card"><div class="stat-title">Carbs</div><div class="stat-value">${Math.round(weeklyStats.avgCarbs||0)}<span class="stat-unit">g</span></div></div>
          <div class="stat-card"><div class="stat-title">Fat</div><div class="stat-value">${Math.round(weeklyStats.avgFat||0)}<span class="stat-unit">g</span></div></div>
          <div class="stat-card"><div class="stat-title">Fiber</div><div class="stat-value">${Math.round(weeklyStats.avgFiber||0)}<span class="stat-unit">g</span></div></div>
      `;
  }

  // ---------------------------
  // Charts (lazy)
  // ---------------------------
  async function loadChartJS() {
      if (ChartsLoaded || window.Chart) return;
      return new Promise((resolve,reject) => {
          const s = document.createElement('script');
          s.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js';
          s.onload = () => { ChartsLoaded = true; resolve(); };
          s.onerror = () => reject(new Error('Failed to load Chart.js'));
          document.head.appendChild(s);
      });
  }

  async function createCharts(weeklyPlan, profile) {
      try { await loadChartJS(); } catch(e){ console.warn('Chart.js not available', e); return; }
      const days = Object.keys(weeklyPlan || {});
      const dailyCalories = days.map(d => {
          let tot = 0;
          Object.keys(weeklyPlan[d]||{}).forEach(mt => tot += safeNumber(weeklyPlan[d][mt]?.calories));
          return tot;
      });
      const weeklyStats = calculateWeeklyStats(weeklyPlan);
      // calorie chart
      try {
          const ctx = document.getElementById('calorieChart');
          if (ctx) {
              if (window.calorieChartInstance && typeof window.calorieChartInstance.destroy === 'function') window.calorieChartInstance.destroy();
              window.calorieChartInstance = new Chart(ctx, {
                  type:'bar',
                  data:{ labels: days.map(d => d.substr(0,3)), datasets:[{ label:'Daily Calories', data:dailyCalories }] },
                  options:{ responsive:true, maintainAspectRatio:false }
              });
          }
      } catch(e) { console.warn('createCharts calorie', e); }

      try {
          const ctx = document.getElementById('macrosChart');
          if (ctx) {
              if (window.macrosChartInstance && typeof window.macrosChartInstance.destroy === 'function') window.macrosChartInstance.destroy();
              const p = weeklyStats.totalProtein*4;
              const c = weeklyStats.totalCarbs*4;
              const f = weeklyStats.totalFat*9;
              window.macrosChartInstance = new Chart(ctx, { type:'doughnut', data:{ labels:['Protein','Carbs','Fat'], datasets:[{ data:[p,c,f] }] }, options:{ responsive:true, maintainAspectRatio:false } });
          }
      } catch(e) { console.warn('createCharts macros', e); }
  }

  // ---------------------------
  // Generate & display plan
  // ---------------------------
  function normalizeKey(value) { if (!value) return ''; return String(value).trim().toLowerCase().replace(/[\s-]+/g, '_'); }

  async function generateMealPlan() {
      try {
          await loadMealsDatabase();

          const profile = {
              age: safeNumber(document.getElementById('age')?.value),
              gender: document.getElementById('gender')?.value,
              height: safeNumber(document.getElementById('height')?.value),
              weight: safeNumber(document.getElementById('weight')?.value),
              goal: document.getElementById('goal')?.value,
              dietType: document.getElementById('dietType')?.value,
              region: document.getElementById('region')?.value,
              activityLevel: document.getElementById('activityLevel')?.value,
              targetCalories: safeNumber(document.getElementById('targetCalories')?.value)
          };

          if (!profile.targetCalories) profile.targetCalories = calculateTargetCalories(profile);

          // region resolution tolerant
          const normRegion = normalizeKey(profile.region);
          let regionKey = Object.keys(mealDatabase || {}).find(k => normalizeKey(k) === normRegion);
          if (!regionKey) regionKey = Object.keys(mealDatabase || {}).find(k => normalizeKey(k).includes(normRegion) || normRegion.includes(normalizeKey(k)));
          if (!regionKey) { DIAG('Region not found: ' + profile.region); throw new Error('Region not found'); }
          const regionMeals = mealDatabase[regionKey];

          // diet resolution
          const normDiet = normalizeKey(profile.dietType);
          let dietKey = Object.keys(regionMeals || {}).find(k => normalizeKey(k) === normDiet);
          if (!dietKey) dietKey = Object.keys(regionMeals || {}).find(k => normalizeKey(k).includes(normDiet) || normDiet.includes(normalizeKey(k)));
          const dietMeals = (regionMeals && (regionMeals[dietKey] || regionMeals['Regular'] || Object.values(regionMeals)[0]));

          if (!dietMeals) { DIAG('Diet not found in region: ' + profile.dietType); throw new Error('Diet not found'); }

          DIAG(`Using region: ${regionKey} | diet: ${dietKey || 'Regular'}`);
          const weeklyPlan = selectMealsForWeek(dietMeals, profile.targetCalories, profile);

          // try replace placeholders with real titled items from pool (if any)
          const mealTypes = ['breakfast','lunch','dinner','snacks'];
          for (const day of Object.keys(weeklyPlan)) {
              for (const mt of mealTypes) {
                  const meal = weeklyPlan[day][mt];
                  if (meal && (!meal.title || /^Option|Mixed|Balanced|Nutritious|Healthy/i.test(String(meal.title)))) {
                      const pool = getMealsArrayForType(dietMeals, mt) || [];
                      const candidate = pool.find(m => m && m.title && !/^Option|Mixed|Balanced|Nutritious|Healthy/i.test(String(m.title)));
                      if (candidate) weeklyPlan[day][mt] = candidate;
                  }
              }
          }

          currentMealPlan = weeklyPlan;
          currentUserProfile = profile;

          try { localStorage.setItem('last_generated_plan_v1', JSON.stringify({ plan: weeklyPlan, profile: profile, generated: new Date().toISOString() })); } catch(e){}

          displayStatsCards(weeklyPlan, profile);
          displayMealTable(weeklyPlan);
          await createCharts(weeklyPlan, profile);

          DIAG('Weekly plan generated for ' + regionKey + ' / ' + (dietKey || 'Regular'));
          console.log('Weekly plan', weeklyPlan);
          return weeklyPlan;
      } catch (err) {
          console.error('generateMealPlan error', err);
          alert('Failed to generate. See console.');
          throw err;
      }
  }

  // ---------------------------
  // CSV / PDF / Tracker
  // ---------------------------
  function downloadCSV() {
      if (!currentMealPlan || !currentUserProfile) { alert('Please generate a meal plan first'); return; }
      let csv = '\uFEFF';
      csv += 'Date,Meal Time,Food Name,Serving Size,Calories,Protein,Carbs,Fat,Fiber\n';
      const days = Object.keys(currentMealPlan);
      const mealTypes = ['breakfast','lunch','dinner','snacks'];
      days.forEach(day => {
          mealTypes.forEach(mt => {
              const meal = (currentMealPlan[day]||{})[mt];
              if (!meal) return;
              const titleSafe = (meal.title && typeof meal.title === 'string') ? meal.title.replace(/"/g,'""') : getMealTitle(meal).replace(/"/g,'""');
              const row = [day, mt.charAt(0).toUpperCase()+mt.slice(1), `"${titleSafe}"`, `"${(meal.serving_size||'N/A').replace(/"/g,'""')}"`, safeNumber(meal.calories), safeNumber(meal.protein), safeNumber(meal.carbs), safeNumber(meal.fat), safeNumber(meal.fiber)].join(',');
              csv += row + '\n';
          });
      });
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `meal-plan-${new Date().toISOString().split('T')[0]}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      DIAG('CSV downloaded');
  }

  async function loadHtml2Pdf() {
      if (Html2PdfLoaded || window.html2pdf) return;
      return new Promise((resolve,reject) => {
          const s = document.createElement('script');
          s.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
          s.onload = () => { Html2PdfLoaded = true; resolve(); };
          s.onerror = () => reject(new Error('Failed to load html2pdf'));
          document.head.appendChild(s);
      });
  }

  async function downloadPDF() {
      if (!currentMealPlan || !currentUserProfile) { alert('Please generate a meal plan first!'); return; }
      try { await loadHtml2Pdf(); } catch(e){ console.error('pdf load',e); alert('PDF library failed to load'); return; }
      const html2pdfLib = window.html2pdf;
      if (!html2pdfLib) { alert('PDF lib not available'); return; }

      const days = Object.keys(currentMealPlan || {});
      const weeklyStats = calculateWeeklyStats(currentMealPlan);
      const esc = s => (s===null||s===undefined) ? '' : String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

      let html = `<div style="font-family:Arial,Helvetica,sans-serif;padding:10px;font-size:11px;color:#222">`;
      html += `<h1 style="text-align:center;color:#007bff;margin:0 0 6px 0">🍽️ The Diet Planner</h1>`;
      html += `<p style="text-align:center;color:#6c757d;margin:0 0 8px 0">Personalized Meal Plan — ${new Date().toLocaleDateString()}</p>`;
      html += `<h3>Weekly Overview</h3><p><strong>Average Calories:</strong> ${Math.round(weeklyStats.avgCalories||0)} kcal</p>`;
      days.forEach((day, idx) => {
          html += `<h4 style="margin:10px 0 6px 0">${esc(day)} (Day ${idx+1})</h4>`;
          html += `<table style="width:100%;border-collapse:collapse;font-size:11px;margin-bottom:8px;">`;
          html += `<thead><tr style="background:#f3f4f6"><th style="padding:6px;border:1px solid #e6e7e9;width:45%">Meal</th><th style="padding:6px;border:1px solid #e6e7e9;width:45%">Food</th><th style="padding:6px;border:1px solid #e6e7e9;width:10%;text-align:center">Cal</th></tr></thead><tbody>`;
          ['breakfast','lunch','dinner','snacks'].forEach(mt => {
              const meal = (currentMealPlan[day]||{})[mt];
              if (!meal) return;
              const foods = Array.isArray(meal.foods) ? meal.foods.map(f => typeof f === 'string' ? f : (f.name||f.title||'')).filter(Boolean).slice(0,6).join(', ') : '';
              const title = getMealTitle(meal);
              const cal = safeNumber(meal.calories);
              html += `<tr style="page-break-inside:avoid"><td style="padding:6px;border:1px solid #e6e7e9"><strong>${esc(title)}</strong></td><td style="padding:6px;border:1px solid #e6e7e9">${esc(foods)}</td><td style="padding:6px;border:1px solid #e6e7e9;text-align:center">${cal}</td></tr>`;
          });
          html += `</tbody></table>`;
      });
      html += `</div>`;

      const temp = document.createElement('div');
      temp.style.width = '800px';
      temp.style.padding = '6px';
      temp.innerHTML = html;
      const style = document.createElement('style');
      style.innerHTML = `thead{display:table-header-group} tr{page-break-inside:avoid} td,th{word-break:break-word}`;
      temp.insertBefore(style, temp.firstChild);
      document.body.appendChild(temp);

      const opt = { margin:8, filename:`TheDietPlanner-MealPlan-${new Date().toISOString().slice(0,10)}.pdf`, image:{type:'jpeg',quality:0.95}, html2canvas:{scale:1.5,useCORS:true}, jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}, pagebreak:{mode:['css','legacy']} };

      try {
          await html2pdfLib().set(opt).from(temp).save();
          DIAG('PDF saved');
      } catch (err) {
          console.error('PDF generation failed', err);
          alert('PDF generation failed. See console.');
      } finally {
          if (temp && temp.parentNode) temp.parentNode.removeChild(temp);
      }
  }

  function sendToTrackerAndRedirect() {
      if (!currentMealPlan || !currentUserProfile) { alert('No meal plan to send. Generate one first.'); return; }
      const overlay = null;
      const integrationData = {
          version: '3.0',
          timestamp: new Date().toISOString(),
          source: 'thedietplanner-diet-planner',
          userProfile: currentUserProfile,
          mealPlan: currentMealPlan,
          dailyTargets: { calories: currentUserProfile.targetCalories, protein: Math.round(currentUserProfile.targetCalories*0.15/4), carbs: Math.round(currentUserProfile.targetCalories*0.5/4), fat: Math.round(currentUserProfile.targetCalories*0.35/9), fiber:25, water:2000 }
      };
      try {
          const payloadStr = JSON.stringify(integrationData);
          localStorage.setItem(INTEGRATION_STORAGE_KEY, payloadStr);
          localStorage.setItem('planned_meals_v1', payloadStr);
          DIAG('Meal plan saved to localStorage for tracker');
      } catch(e){ console.warn(e); }

      const go = confirm('Meal plan saved for Diet Tracker. Open tracker now?');
      if (go) {
          const redirectUrl = document.body.getAttribute('data-diet-tracker-url') || (location.origin + '/diet-tracker');
          const w = window.open(redirectUrl, '_blank');
          if (!w) alert('Popup blocked. Please open tracker manually.');
      }
  }

  // ---------------------------
  // Load saved plan
  // ---------------------------
  function loadExistingPlan() {
      try {
          const stored = localStorage.getItem('last_generated_plan_v1');
          if (!stored) { DIAG('No last_generated_plan_v1 in localStorage'); return; }
          const data = JSON.parse(stored);
          const generated = new Date(data.generated);
          const now = new Date();
          const daysDiff = (now - generated) / (1000*60*60*24);
          if (daysDiff <= 7 && data.plan && data.profile) {
              currentMealPlan = data.plan;
              currentUserProfile = data.profile;
              // populate form if fields exist
              try {
                  Object.keys(currentUserProfile).forEach(key => {
                      const fld = document.getElementById(key);
                      if (fld && currentUserProfile[key] !== undefined) fld.value = currentUserProfile[key];
                  });
              } catch(e){}
              displayStatsCards(currentMealPlan, currentUserProfile);
              displayMealTable(currentMealPlan);
              createCharts(currentMealPlan, currentUserProfile);
              DIAG('Loaded existing plan from localStorage');
          }
      } catch(e){ console.error('loadExistingPlan error', e); }
  }

  // ---------------------------
  // Initialization stubs (safe)
  // ---------------------------
  function initializeTheme(){ /* stub for compatibility */ }
  function initializeNavigation(){ /* stub for compatibility */ }
  function initializeMobileMenu(){ /* stub for compatibility */ }
  function initializeIntersectionObserver(){ /* stub for compatibility */ }
  function initializeResultsToggle(){ /* stub for compatibility */ }
  function initializeForm(){ /* stub for compatibility */ }
  function initializePdfExport(){ /* stub for compatibility */ }

  // ---------------------------
  // wire UI
  // ---------------------------
  document.addEventListener('DOMContentLoaded', () => {
      // button wiring
      const gen = document.getElementById('generateBtn');
      if (gen) gen.addEventListener('click', () => { gen.disabled = true; generateMealPlan().finally(()=>gen.disabled=false); });

      const pdfBtn = document.getElementById('downloadPdfBtn');
      if (pdfBtn) pdfBtn.addEventListener('click', () => { pdfBtn.disabled = true; downloadPDF().finally(()=>pdfBtn.disabled=false); });

      const csvBtn = document.getElementById('downloadCsvBtn');
      if (csvBtn) csvBtn.addEventListener('click', downloadCSV);

      const sendBtn = document.getElementById('sendToTrackerBtn');
      if (sendBtn) sendBtn.addEventListener('click', sendToTrackerAndRedirect);

      // try load db and existing plan
      loadMealsDatabase().catch(()=>{});
      loadExistingPlan();
      DIAG('Diet Planner loaded (consolidated)');
  });

  // Expose to window for debug
  window.generateMealPlan = generateMealPlan;
  window.loadMealsDatabase = loadMealsDatabase;
  window.downloadPDF = downloadPDF;
  window.downloadCSV = downloadCSV;
  window.sendToTrackerAndRedirect = sendToTrackerAndRedirect;
  </script>
</body>
</html>
